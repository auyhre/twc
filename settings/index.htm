<!DOCTYPE html>
<html>
    <head>
        <title>TWC Configuration</title>
        <link rel='stylesheet' type='text/css' href='css/slate.css'>
            <script src='js/slate.js'></script>
            <style>
                .title {
                    padding: 15px 10px;
                    text-transform: uppercase;
                    font-family: 'PT Sans', sans-serif;
                    font-size: 1.2em;
                    font-weight: 500;
                    color: #888888;
                    text-align: center;
                }
            </style>
            </head>
    
    <body>
        <h1 class='title'>TWC Configuration</h1>
        
        <div class='item-container'>
            <div class='item-container-header'>Theme Settings</div>
            <div class='item-container-content'>
                <label class='item'>
                    Dynamic Background Color
                    <input id='dynamic_temperature_background_checkbox' type='checkbox' class='item-toggle'>
                        </label>
            </div>
            <div class='item-container-footer'>
                Dynamically change the background color based on the current temperature.
            </div>
            
            <label class="item">
              Background Color
              <input type="text" id="background_color" class="item-color item-color-normal" name="color-2" value="#000000">
            </label>    
            
            <label class="item">
              Text Color
              <input type="text" id="foreground_color" class="item-color item-color-normal" name="color-2" value="#FFFFFF">
            </label>
        </div>
        
        <div class="item-container">
            <div class="item-container-header">Tab Buttons</div>
            <div class="item-container-content">
                <div class="item tab-buttons">
                    <a name="tab-units" class="tab-button active">Fahrenheit</a>
                    <a name="tab-units" class="tab-button">Celcius</a>
                </div>
            </div>
        </div>
        
        <div class="item-container">
            <div class="item-container-header">Weather Underground API Key</div>
            <div class="item-container-content">
                <label class="item">
                    <div class="item-input-wrapper">
                        <input id="wu_api_key" type="text" class="item-input" name="input-1" placeholder="Input field">
                            </div>
                </label>
                <div class='item-container-footer'>
                    If you have a WUnderground API key, type it here and WUnderground will be used for the current weather.
                    If you don't have an API key, leave this blank and OpenWeatherMap.org will be used for the current weather.
                    If any errors are encountered downloading weather from WUnderground, TWC will fall back to OpenWeatherMap.org.
                </div>
            </div>
        </div>
        
        <div class='item-container'>
            <div class='button-container'>
                <input id='submit_button' type='button' class='item-button' value='SAVE'>
                    </div>
        </div>
    </body>
    <script>
        function getConfigData() {
            var dynamicTemperatureBackgroundCheckbox = document.getElementById('dynamic_temperature_background_checkbox');
            var backgroundColor = document.getElementById('background_color');
            var foregroundColor = document.getElementById('foreground_color');
            var unitIndex = getTabIndex('tab-units');
            var WUAPIKey = document.getElementById('wu_api_key');
            
            var options = {
                'dynamic_temperature_background': dynamicTemperatureBackgroundCheckbox.checked,
                'background_color': background_color.value,
                'foreground_color': foreground_color.value,
                'units': unitIndex,
                'wu_api_key': WUAPIKey.value
            };
            // Save for next launch
            localStorage['dynamic_temperature_background'] = options['dynamic_temperature_background'];
            localStorage['background_color'] = options['background_color'];
            localStorage['foreground_color'] = options['foreground_color'];
            localStorage['units'] = options['units'];
            localStorage['wu_api_key'] = options['wu_api_key'];
            console.log('Got options: ' + JSON.stringify(options));
            return options;
        }
        function getQueryParam(variable, defaultValue) {
            var query = location.search.substring(1);
            var vars = query.split('&');
            for (var i = 0; i < vars.length; i++) {
                var pair = vars[i].split('=');
                if (pair[0] === variable) {
                    return decodeURIComponent(pair[1]);
                }
            }
            return defaultValue || false;
        }
        
        var submitButton = document.getElementById('submit_button');
        submitButton.addEventListener('click', function() {
                                      console.log('Submit');
                                      // Set the return URL depending on the runtime environment
                                      var return_to = getQueryParam('return_to', 'pebblejs://close#');
                                      document.location = return_to + encodeURIComponent(JSON.stringify(getConfigData()));
                                      });
          (function() {
           var dynamicTemperatureBackgroundCheckbox = document.getElementById('dynamic_temperature_background_checkbox');
           var backgroundColor = document.getElementById('background_color');
           var foregroundColor = document.getElementById('foreground_color');
           var WUAPIKey = document.getElementById('wu_api_key');
           // Load any previously saved configuration, if available
           if(localStorage['dynamic_temperature_background']) {
                dynamicTemperatureBackgroundCheckbox.checked = JSON.parse(localStorage['dynamic_temperature_background']);
                backgroundColor.value = localStorage['background_color'];
                foregroundColor.value = localStorage['foreground_color'];
                setTabIndex('tab-units',localStorage['units']);
                WUAPIKey.value = localStorage['wu_api'];
           }
           })();
                                           
           function getTabIndex(elementName) {
               var tabs = document.getElementsByName(elementName);
               for(var t = 0; t < tabs.length; t++) {
                   var tbclasses = tabs[t].className.split(" ");
                   for(var i = 0; i < tbclasses.length; i++) {
                       if(tbclasses[i] === "active") {
                           return t;
                       }
                   }
               }
           }
            
            function setTabIndex(elementName, index) {
                var tabs = document.getElementsByName(elementName);
                for(var t = 0; t < tabs.length; t++) {
                    tabs[t].className = "tab-button";
                }
                tabs[index].className = "tab-button active";
            }
    
        </script>
</html>
